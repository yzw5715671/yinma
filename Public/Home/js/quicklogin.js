// Generated by CoffeeScript 1.9.2
var api, quickLogin;

api = {
  login: '/user/login',
  bind: '/weixin/bindAccount',
  register: '/weixin/createnewuser',
  modifyPassword: '/user/modifypwd',
  checkLogin: '/user/checklogin'
};

$('#btnFollow').click(function() {
  var $this;
  $this = $(this);
  $.getJSON(api.checkLogin).then(function(json) {
    if (json.success) {
      return location.href = $this.attr('href');
    } else {
      return $.layer({
        type: 1,
        area: ['450px', '475px'],
        title: false,
        page: {
          dom: '#quicklogin'
        }
      });
    }
  });
  return false;
});

quickLogin = (function() {
  var $loginBox, $passBox, $quickLogin, $regBox, bindEvent, that;
  $quickLogin = $('#quicklogin');
  $loginBox = $('.login-box');
  $regBox = $('.reg-box');
  $passBox = $('.change-password-box');
  bindEvent = function() {
    var formData, lastMobile, showInputPassword, showInputSMS, validReg, wxLogin;
    $quickLogin.find('.tab-title').click(function(e) {
      var $this, left, target;
      $this = $(this).addClass('active');
      $this.siblings('.active').removeClass('active');
      target = $this.data('target');
      left = parseInt($quickLogin.find('.' + target).data('index')) * 320;
      $('.step').css('left', -left);
      setTimeout(function() {
        if (!e.isTrigger) {
          return $('.' + target).find('input').eq(0).focus();
        }
      }, 300);
      if (target === 'change-password-box') {
        return $quickLogin.find('.tab-title').css('left', '-320px');
      }
    });
    $quickLogin.find('.btn-login').click(function() {
      var $this;
      $this = $(this);
      return $.post(api.login, {
        username: $loginBox.find('.username').val(),
        password: $loginBox.find('.password').val(),
        'remember-user': $loginBox.find('#remember').val()
      }).then(function(json) {
        var $msg;
        $msg = $loginBox.find('.message').removeClass().addClass('message').text(json.info);
        if (json.status === 1) {
          location.href = $('#btnFollow').attr('href');
          return $msg.addClass('success');
        } else {
          return $msg.addClass('error');
        }
      });
    });
    formData = {};
    lastMobile = 0;
    showInputPassword = function() {
      $regBox.find('.message').text('您的手机号已经注册，请登录或找回密码');
      $regBox.find('.sms').addClass('hidden');
      $('.tab-title').filter('.login').trigger('click');
      $loginBox.find('.message').removeClass().addClass('message success').text('您的手机号已经注册，请登录或找回密码');
      $regBox.find('.btn-next').attr('disabled', 'disabled').addClass('disabled');
      $loginBox.find('.username').val($regBox.find('.username').val());
      return $loginBox.find('.password').focus();
    };
    showInputSMS = function() {
      var $btnSendSMS, intervalId, longtime, tick;
      $regBox.find('.message').text('您的手机号尚未注册，请验证您的手机号码');
      $regBox.find('.sms').removeClass('hidden');
      $regBox.find('.btn-next').removeAttr('disabled').removeClass('disabled');
      $('.input-sms').focus();
      longtime = 0;
      $btnSendSMS = $regBox.find('.btn-send-sms');
      intervalId = 0;
      tick = function() {
        $btnSendSMS.html('请稍等' + longtime + '秒');
        longtime = longtime - 1;
        if (longtime <= 0) {
          clearInterval(intervalId);
          $btnSendSMS.removeAttr('disabled').removeClass('disabled').html('获取验证码');
        }
      };
      $btnSendSMS.unbind().click(function() {
        var phone;
        $(this).attr('disabled', 'disabled').addClass('disabled');
        phone = $regBox.find('.username').val();
        if (longtime > 0) {
          return false;
        }
        $.post($(this).attr('href'), {
          'phone': phone
        }, function(json) {
          if (json.status === 1) {
            longtime = 120;
            $btnSendSMS.html('请稍等' + longtime + '秒');
            intervalId = setInterval(tick, 1000);
          } else {
            alert(json.info);
          }
        });
        return false;
      });
    };
    validReg = function(d) {
      var $msg;
      $msg = $regBox.find('.message');
      if (!d.verify) {
        $msg.removeClass().addClass('message error').text('请输入验证码');
        return;
      }
      if (d.password !== d.repassword) {
        $msg.removeClass().addClass('message error').text('输入的密码不一致, 请检查');
      }
    };
    $regBox.find('.btn-next').click(function() {
      var $button;
      formData.mobile = $regBox.find('.username').val();
      formData.verify = $regBox.find('.input-sms').val();
      formData.password = $regBox.find('.password').eq(0).val();
      formData.repassword = $regBox.find('.re-password').val();
      validReg(formData);
      $button = $(this);
      $button.attr('disabled', 'disabled').addClass('disabled').text('正在验证...');
      $.post(api.register, formData).then(function(json) {
        if (json.success) {
          $button.text('注册成功 √');
          return 'success';
        } else {
          layer.msg(json.info, 2, -1);
          return json.info;
        }
      }, function() {
        return 'fail';
      }).always(function(result) {
        if (result === 'success') {
          location.href = $('#btnFollow').attr('href');
        } else {
          $button.removeAttr('disabled').removeClass('disabled').text('重试');
        }
      });
      return false;
    });
    $passBox.find('.btn-finish').click(function() {
      return $.post(api.modifyPassword, {
        old: $regBox.find('.username').val().trim().slice(-6),
        password: $passBox.find('.password').val(),
        repassword: $passBox.find('.re-password').val()
      }).then(function(json) {
        if (json.success) {
          return location.href = $('#btnFollow').attr('href');
        } else {
          return layer.msg(json.info, 2, -1);
        }
      });
    });
    $regBox.find('.username').bind('input propertychange', function() {
      var $this;
      $this = $(this);
      setTimeout(function() {
        var $username, val;
        val = $this.val();
        if (val === lastMobile) {
          return;
        }
        if (val.match(/^(0|86|17951)?(1[3578])[0-9]{9}$/)) {
          lastMobile = val;
          $username = $regBox.find('.username').attr('disabled', 'disabled').addClass('disabled').click(function() {
            $(this).removeClass('disabled');
          });
          $regBox.find('.message').removeClass().addClass('message success').text('检查手机号...');
          $.get('/weixin/checkBindMobile', {
            mobile: $this.val()
          }).then(function(json) {
            $username.removeAttr('disabled');
            if (json.success) {
              if (json.exist) {
                showInputPassword();
              } else {
                showInputSMS();
              }
            } else {

            }
          });
        } else {

        }
      }, 0);
    });
    wxLogin = function() {
      new WxLogin({
        id: 'login_container',
        appid: 'wxc828421ba4322f23',
        scope: 'snsapi_login',
        //redirect_uri: 'http://www.dreammove.cn/Weixin/loginWx?pid=' + serverData.projectId,
        redirect_uri: 'http://123.57.139.172',
        state: 'dreammove2015',
        style: 'black',
        href: ''
      });
    };
    return $('.btn-wx-login').click(function() {
      wxLogin();
      sessionStorage.setItem('loginRedirect', $('#btnFollow').attr('href'));
      $.layer({
        type: 1,
        area: ['300px', '409px'],
        title: false,
        border: [0],
        shadeClose: true,
        page: {
          dom: '#login_container'
        }
      });
      return false;
    });
  };
  that = {};
  that.init = function() {
    return bindEvent();
  };
  return that;
})();

quickLogin.init();
